<!--
Name: Soh Hong Yu
Class: DAAA/FT/1B/01
Admin No.: P2100775
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SP IT!</title>
    <link rel="shortcut icon" href="img/SPIT.png" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"
      integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn"
      crossorigin="anonymous"
    />
    <link href="http://fonts.cdnfonts.com/css/futura-pt" rel="stylesheet" />
    <link rel="stylesheet" href="css/main.css" />

    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
      integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="css/profile.css" />
  </head>

  <body>
    <nav class="navbar navbar-expand-md navbar-light bg-white">
      <div class="container">
        <a
          class="navbar-brand d-flex align-items-center justify-content-between"
          style="gap: 10px"
          href="index.html"
          ><img src="img/SPIT Dark.png" style="max-height: 60px" />SP IT!</a
        >
      </div>
    </nav>
    <div
      class="d-flex w-100 justify-content-center align-items-center container flex-column"
    >
      <button
        style="
          border: none;
          background: transparent;
          aspect-ratio: 1;
          width: 117px;
        "
        class="p-0 mb-4"
        data-toggle="modal"
        data-target="#imgUpload"
      >
        <img
          id="profilePic"
          src="http://localhost:8081/img/default.png"
          style="
            border-radius: 100%;
            aspect-ratio: 1;
            width: 112px;
            border: 1px black solid;
            object-fit: contain;
          "
        />
      </button>
      <div
        class="modal fade"
        id="imgUpload"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content" id="drop-area">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Profile image</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div
              class="modal-body d-flex justify-content-center align-items-center p-0"
            >
              <div class="file-upload w-100">
                <form
                  class="image-upload-wrap d-flex justify-content-center align-items-center"
                  style="height: 240px"
                >
                  <input
                    class="file-upload-input"
                    type="file"
                    onchange="readURL(this);"
                    accept="image/*"
                    id="imageFile"
                  />

                  <div
                    class="drag-text w-100 d-flex flex-column justify-content-center align-items-center"
                  >
                    <div id="imageErr" class="text-danger d-none">
                      Invalid Image
                    </div>
                    <h3>Drag photo here</h3>
                    <p>— or —</p>
                    <button
                      class="btn bg-secondary text-white font-weight-bold text-center"
                      type="button"
                      style="white-space: nowrap; z-index: 1055"
                      id="addImage"
                      onclick="$('.file-upload-input').trigger( 'click' )"
                    >
                      Choose photo to upload
                    </button>
                  </div>
                </form>
                <div class="file-upload-content">
                  <img
                    class="file-upload-image"
                    style="
                      border: 1px black solid;
                      object-fit: contain;
                      aspect-ratio: 1;
                      width: 112px;
                    "
                    src="#"
                    alt="your image"
                    id="newImage"
                  />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
                id="close"
              >
                Close
              </button>
              <button type="button" class="btn btn-primary" id="save">
                Save as profile picture
              </button>
            </div>
          </div>
        </div>
      </div>
      <form class="d-flex flex-column justify-content-center" id="profileInfo">
        <div
          class="d-flex justify-content-center align-items-center"
          style="gap: 10px"
          id="updateProfileButton"
        >
          <button
            type="button"
            class="btn bg-secondary text-white font-weight-bold w-75 align-self-center mb-4 d-none"
            id="cancel"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn bg-secondary text-white font-weight-bold w-75 align-self-center mb-4"
            id="editProfile"
          >
            Edit profile
          </button>
        </div>
        <div class="d-flex" style="gap: 10px">
          <button
            type="button"
            class="btn bg-secondary text-white font-weight-bold w-75 align-self-center mb-4"
            id="back"
          >
            Back
          </button>
          <button
            type="button"
            class="btn bg-secondary text-white font-weight-bold w-75 align-self-center mb-4"
            id="logOut"
            data-toggle="modal"
            data-target="#logoutWarning"
          >
            Log out
          </button>
          <div
            class="modal fade"
            id="logoutWarning"
            tabindex="-1"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Log out</h5>
                  <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">Are you sure?</div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" id="log">
                    Yes
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-dismiss="modal"
                  >
                    No
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>

      <div
        class="modal fade"
        id="interestModal"
        data-backdrop="static"
        data-keyboard="false"
        tabindex="-1"
        aria-labelledby="interestModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="interestModalLabel">
                Select your interests:
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div id="interestCategory" class="container"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" id="continue">
                Continue
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer class="container my-4">
      &copy; 2022 SP IT!. All Rights Reserved.
    </footer>
    <!--JS Libraries-->
    <script
      src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
      integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2"
      crossorigin="anonymous"
    ></script>
    <!--AXIOS-->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!--JQuery-->
    <script>
      const baseUrl = "http://localhost:8081";
      $("#log").click(() => {
        localStorage.removeItem("token");
        localStorage.removeItem("userid");
        localStorage.removeItem("editProduct");
        localStorage.removeItem("goingProduct");
        localStorage.removeItem("movingDir");
        localStorage.removeItem("profileData");
        localStorage.removeItem("creditNum");
        localStorage.removeItem("address");
        window.location.href = "/";
      });
      $("#editProfile").click(() => {
        if ($("#cancel").hasClass("d-none")) {
          $("#cancel").toggleClass("d-none");
          $("#editProfile").html(`Save profile`);
          for (var i = 0; i < $(".group input").length; i++) {
            document
              .getElementsByClassName("group")
              [i].querySelector("input").readOnly = false;
          }
          document.getElementsByClassName("group")[i - 1].style = "";
          if ($("#err").prev()[0].firstElementChild.id == "contact") {
            $("#err").before(`<div id="passwords">
                  <div class="group">
                    <input type="password" id="nPassword" oninput="hide()" required />
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label>New Password</label>
                  </div>
                  <div class="group" style="margin-bottom: 10px">
                    <input type="password" id="CNPassword" oninput="hide()" required />
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label>Confirm New Password</label>
                  </div>
            </div>`);
          }
        } else {
          if (
            $("#username").val().trim().length > 0 &&
            $("#email").val().trim().length > 0 &&
            $("#contact").val().trim().length > 0
          ) {
            var data = {
              username: $("#username").val(),
              email: $("#email").val(),
              contact: $("#contact").val(),
            };
            if (
              $("#nPassword").val().trim().length > 0 ||
              $("#CNPassword").val().trim().length > 0
            ) {
              if ($("#nPassword").val() == $("#CNPassword").val()) {
                data.password = $("#nPassword").val();
              } else {
                if ($("#err").hasClass("invisible")) {
                  $("#err").toggleClass("invisible");
                }
                $("#err").html(`Passwords do not match`);
                return;
              }
            }
            axios
              .put(`${baseUrl}/users/${localStorage.getItem("userid")}`, data, {
                headers: {
                  Authorization: "Bearer " + localStorage.getItem("token"),
                },
              })
              .then((response) => {
                console.log(response.data);
                if (!$("#cancel").hasClass("d-none")) {
                  $("#cancel").toggleClass("d-none");
                }
                $("#editProfile").html(`Edit profile`);
                if ($("#err").prev()[0].id == "passwords") {
                  $("#err").prev()[0].remove();
                }
                for (var i = 0; i < $(".group input").length; i++) {
                  document
                    .getElementsByClassName("group")
                    [i].querySelector("input").readOnly = true;
                }
                document.getElementsByClassName("group")[i - 1].style =
                  "margin-bottom: 10px";
              })
              .catch((err) => {
                if ($("#err").hasClass("invisible")) {
                  $("#err").toggleClass("invisible");
                }
                $("#err").html(`Username or email has been taken`);
                console.log(err);
                return err;
              });
          } else {
            if ($("#err").hasClass("invisible")) {
              $("#err").toggleClass("invisible");
              $("#err").html(`Values cannot be empty`);
            }
          }
        }
      });
      $("#cancel").click(() => {
        hide();
        if (!$("#cancel").hasClass("d-none")) {
          $("#cancel").toggleClass("d-none");
        }
        $("#editProfile").html(`Edit profile`);
        var profileData = JSON.parse(localStorage.getItem("profileData"));
        if ($("#err").prev()[0].id == "passwords") {
          $("#err").prev()[0].remove();
        }
        for (var i = 0; i < $(".group input").length; i++) {
          document
            .getElementsByClassName("group")
            [i].querySelector("input").readOnly = true;
          $(".group input")
            .eq(i)
            .val(profileData[$(".group input").eq(i).attr("id")]);
        }
        document.getElementsByClassName("group")[i - 1].style =
          "margin-bottom: 10px";
      });
      var hide = () => {
        if (!$("#err").hasClass("invisible")) {
          $("#err").toggleClass("invisible");
        }
      };
      var loadData = async () => {
        await axios
          .get(`${baseUrl}/users/${localStorage.getItem("userid")}/`)
          .then((response) => {
            console.log(response.data);
            $("#profilePic").attr(
              "src",
              `${baseUrl}${response.data.profile_pic_url.substring(1)}`
            );
            localStorage.setItem("profileData", JSON.stringify(response.data));
            $("#profileInfo").prepend(`
                <div class="group">
                  <input type="text" id="username" oninput="hide()" value="${response.data.username}" readonly required />
                  <span class="highlight"></span>
                  <span class="bar"></span>
                  <label>Username</label>
                </div>
                <div class="group">
                  <input type="text" id="email" oninput="hide()" value="${response.data.email}" readonly required />
                  <span class="highlight"></span>
                  <span class="bar"></span>
                  <label>Email</label>
                </div>
                <div class="group"  style="margin-bottom: 10px">
                  <input type="text" id="contact" oninput="hide()" value="${response.data.contact}" readonly required />
                  <span class="highlight"></span>
                  <span class="bar"></span>
                  <label>Contact</label>
                </div>
                <div
                  id="err"
                  class="text-danger mb-2 invisible"
                  style="font-size: 12px"
                >
                  Values cannot be empty
                </div>
              `);
            if ($("#err").next()[0].getAttribute("id") != "addCategoryModal") {
              $("#updateProfileButton").before(`
                  <button
                    type="button"
                    class="btn bg-secondary text-white font-weight-bold w-75  align-self-center mb-4"
                    id="addCategoryModal"
                    onclick="generateInterestCategory();"
                  >
                    Add interests
                  </button>`);
            }
            if (response.data.type == "Admin") {
              if (
                $("#updateProfileButton").prev()[0].getAttribute("id") !=
                "admin"
              ) {
                $("#updateProfileButton").before(`
                  <button
                    type="button"
                    class="btn bg-secondary text-white font-weight-bold w-75  align-self-center mb-4"
                    id="admin"
                    onclick="window.location.href='/admin.html'"
                  >
                    Admin Panel
                  </button>`);
              }
            } else {
              if ($("#updateProfileButton").prev()[0].tagName != "A") {
                $("#updateProfileButton").before(`<a
                  href="pastcart.html"
                  class="btn bg-secondary text-white font-weight-bold w-75 align-self-center mb-4"
                  id="past"
                >
                  View past purchases
                </a>`);
              }
            }
          })
          .catch((err) => {
            console.log(err);
          });
      };
      $("#back").click(() => {
        localStorage.removeItem("profileData");
        window.location.href = localStorage.getItem("movingDir");
      });
      $(document).ready(() => {
        if (!localStorage.getItem("token")) {
          window.location.href = "/login.html";
        }
        loadData();
        if ($("#save").hasClass("btn-primary")) {
          $("#save").toggleClass("btn-primary");
          $("#save").addClass("btn-danger");
          $("#save").html("Remove current profile picture");
        }
      });
      // Images
      function readURL(input) {
        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function (e) {
            $(".image-upload-wrap").addClass("d-none");
            $(".image-upload-wrap").removeClass("d-flex");
            $("#addImage").hide();
            $(".file-upload-image").attr("src", e.target.result);
            $(".file-upload-content").addClass(
              "d-flex justify-content-center align-items-center"
            );
            $(".file-upload-content").removeClass("d-none");
            if ($("#save").hasClass("btn-danger")) {
              $("#save").toggleClass("btn-danger");
              $("#save").addClass("btn-primary");
              $("#save").html("Save as profile picture");
            }
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          removeUpload();
        }
      }
      function removeUpload() {
        $("#addImage").show();
        $(".file-upload-input").replaceWith($(".file-upload-input").clone());
        $(".file-upload-content").addClass("d-none");
        $(".file-upload-content").removeClass("d-flex");
        $(".image-upload-wrap").addClass("d-flex");
        $(".image-upload-wrap").removeClass("d-none");
        $(".image-upload-wrap").removeClass("image-dropping");
        if ($("#save").hasClass("btn-primary")) {
          $("#save").toggleClass("btn-primary");
          $("#save").addClass("btn-danger");
          $("#save").html("Remove profile picture");
        }
      }
      $(".image-upload-wrap").bind("dragover", function () {
        $(".image-upload-wrap").addClass("image-dropping");
      });
      $(".image-upload-wrap").bind("dragleave", function () {
        $(".image-upload-wrap").removeClass("image-dropping");
      });
      $("#close").click(() => {
        $(".file-upload-input").val("");
        removeUpload();
      });
      $("#save").click(async () => {
        if ($("#save").hasClass("btn-primary")) {
          if (!$("#imageErr").hasClass("d-none")) {
            $("#imageErr").toggleClass("d-none");
          }
          if ($("#imageFile")[0].files && $("#imageFile")[0].files[0]) {
            var formData = new FormData();
            console.log($("#imageFile")[0].files[0]);
            formData.append("profile_pic_url", $("#imageFile")[0].files[0]);
            formData.append("username", $("#username").val());
            await axios
              .put(
                `${baseUrl}/users/${localStorage.getItem("userid")}`,
                formData,
                {
                  headers: {
                    Authorization: "Bearer " + localStorage.getItem("token"),
                  },
                }
              )
              .then((response) => {
                console.log(response);
              })
              .catch((err) => {
                console.log(err);
                if ($("#imageErr").hasClass("d-none")) {
                  $("#imageErr").toggleClass("d-none");
                }
                $(".file-upload-content").addClass("d-none");
                $(".file-upload-content").removeClass("d-flex");
                $(".image-upload-wrap").addClass("d-flex");
                $(".image-upload-wrap").removeClass("d-none");
                $("#addImage").show();
              });
            if ($("#imageErr").hasClass("d-none")) {
              var childList = $("#profileInfo").children();
              for (var i = 0; i < childList.length; i++) {
                if (
                  childList[i].classList.contains("group") ||
                  childList[i].getAttribute("id") == "err"
                ) {
                  childList[i].remove();
                }
              }
              $("#imgUpload").modal("toggle");
              removeUpload();
              loadData();
            }
          }
        } else {
          var formData = new FormData();
          formData.append("profile_pic_url", "");
          await axios
            .put(
              `${baseUrl}/users/${localStorage.getItem("userid")}`,
              formData,
              {
                headers: {
                  Authorization: "Bearer " + localStorage.getItem("token"),
                },
              }
            )
            .then((response) => {
              console.log(response);
            })
            .catch((err) => {
              console.log(err);
            });
          var childList = $("#profileInfo").children();
          for (var i = 0; i < childList.length; i++) {
            if (
              childList[i].classList.contains("group") ||
              childList[i].getAttribute("id") == "err"
            ) {
              childList[i].remove();
            }
          }
          $("#imgUpload").modal("toggle");
          removeUpload();
          loadData();
        }
      });
      $("#admin").click(() => {
        console.log("hi");
        // window.location.href = "/cart.html";
      });
      var generateInterestCategory = () => {
        axios
          .get(`${baseUrl}/category`)
          .then(async (response) => {
            $("#interestModal").modal("show");
            $("#interestCategory").empty();
            var cateArr = [];
            await axios
              .get(`${baseUrl}/interest/${localStorage.getItem("userid")}`, {
                headers: {
                  Authorization: "Bearer " + localStorage.getItem("token"),
                },
              })
              .then(async (result) => {
                for await (const cate of result.data) {
                  cateArr.push(cate.categoryid);
                }
              })
              .catch((err) => {
                console.log(err);
              });
            console.log(cateArr);
            for await (const item of response.data) {
              $(function () {
                $('[data-toggle="tooltip"]').tooltip();
              });
              $("#interestCategory").append(`
                <label class="checkbox-container" style="width:fit-content" data-toggle="tooltip" data-placement="right" title="${
                  item.description
                }">
                  <div class="d-flex align-items-center">
                    <p class="m-0">${item.category}</p>
                    <img src="${baseUrl}${item.category_pic_url.substring(
                1
              )}" class="mx-2" style="width:30px; aspect-ratio: 1;"/>
                  </div>
                  <input type="checkbox" id="selected${item.categoryid}"/>
                  <i class="far fa-heart heart"></i>
                  <i class="fas fa-heart heart"></i>
                </label>
              `);
              if (cateArr.includes(item.categoryid)) {
                document.getElementById(
                  `selected${item.categoryid}`
                ).checked = true;
              }
            }
          })
          .catch((err) => {
            console.log(err);
          });
      };
      $("#continue").click(async () => {
        var currentCategoryArr = [];
        await axios
          .get(`${baseUrl}/interest/${localStorage.getItem("userid")}`, {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          })
          .then(async (result) => {
            for await (const cate of result.data) {
              currentCategoryArr.push(cate.categoryid);
            }
          })
          .catch((err) => {
            console.log(err);
          });
        var newInterestArr = [
          ...document.getElementById("interestCategory").children,
        ].map((element) => {
          if (element.children[1].checked) {
            return element.children[1].id.match(/\d/g).join("");
          }
          return "";
        });
        newInterestArr = newInterestArr
          .filter((e) => e)
          .map((x) => {
            return parseInt(x);
          });
        removeInterestArr = [...difference(currentCategoryArr, newInterestArr)];
        addInterestArr = [...difference(newInterestArr, currentCategoryArr)];
        if (addInterestArr.length > 0) {
          await axios
            .post(
              `${baseUrl}/interest/${localStorage.getItem("userid")}`,
              {
                categoryids: addInterestArr.join(","),
              },
              {
                headers: {
                  Authorization: "Bearer " + localStorage.getItem("token"),
                },
              }
            )
            .then(async (response) => {
              console.log(response.data);
            })
            .catch((err) => {
              console.log(err);
            });
        }
        if (removeInterestArr.length > 0) {
          await axios
            .delete(`${baseUrl}/interest/${localStorage.getItem("userid")}`, {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
              data: {
                categoryids: removeInterestArr.join(","),
              },
            })
            .then((response) => {
              console.log(response.data);
            })
            .catch((err) => {
              console.log(err);
            });
        }
        $("#interestModal").modal("hide");
      });
      var difference = (setA, setB) => {
        setA = new Set(setA);
        setB = new Set(setB);
        let _difference = new Set(setA);
        for (let element of setB) {
          _difference.delete(element);
        }
        return _difference;
      };
      function intersection(setA, setB) {
        let _intersection = new Set();
        for (let element of setB) {
          if (setA.has(element)) {
            _intersection.add(element);
          }
        }
        return _intersection;
      }
    </script>
    <style>
      #newImage {
        object-fit: contain;
      }
    </style>
    <script>
      // Detect if user tamper with log in user id
      const userid = localStorage.getItem("userid");
      const token = localStorage.getItem("token");
      window.addEventListener(
        "storage",
        function () {
          const newUserId = localStorage.getItem("userid");
          const newToken = localStorage.getItem("token");
          if (newUserId != userid) {
            localStorage.setItem("userid", userid);
            window.location.reload();
          }
          if (newToken != token) {
            localStorage.setItem("token", token);
            window.location.reload();
          }
        },
        false
      );
    </script>
  </body>
</html>
